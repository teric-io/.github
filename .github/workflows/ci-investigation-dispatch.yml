# FEAT-038: CI Investigation Dispatch
#
# Reusable workflow that dispatches a CI investigator agent when tests fail.
# Handles both post-merge (E2E failures on main) and pre-merge (CI failures on PRs).
#
# Call this workflow from:
# - e2e-failure-handler.yml (post-merge E2E failures)
# - pr-ci-failure-handler.yml (pre-merge CI failures on PRs)
#
# The workflow:
# 1. Redacts secrets from test output
# 2. Collects recent commits (post-merge) or PR diff (pre-merge)
# 3. Dispatches teric-ci-investigator via orchestrator API
#
# Prerequisites:
# - Orchestrator API Gateway with POST /dispatch endpoint
# - teric-ci-investigator agent registered in agent registry
# - ORCHESTRATOR_DISPATCH_TOKEN org secret for API authentication
#
# Related:
# - teric-planning/FEAT-038-automated-ci-failure-investigation.md
# - terraform-definitions/aws-agentic/feat-038-ci-investigation.tf

name: CI Investigation Dispatch

on:
  workflow_call:
    inputs:
      source:
        description: 'Failure source: e2e-failure or ci-failure'
        required: true
        type: string
      mode:
        description: 'Investigation mode: post-merge or pre-merge'
        required: true
        type: string
      repository:
        description: 'Repository that failed (e.g., teric-io/app-code-review)'
        required: true
        type: string
      failed_tests:
        description: 'JSON array of failed test names'
        required: true
        type: string
      test_output:
        description: 'Test output logs (will be redacted for secrets)'
        required: true
        type: string
      run_id:
        description: 'GitHub Actions run ID for the failed workflow'
        required: false
        type: string
        default: ''
      commit_sha:
        description: 'Commit SHA that triggered the failure'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number (for pre-merge mode)'
        required: false
        type: number
        default: 0
    secrets:
      ORCHESTRATOR_DISPATCH_TOKEN:
        required: true

env:
  # Source of truth: terraform-definitions/aws-agentic/config.json
  AWS_REGION: us-west-2

jobs:
  dispatch-investigation:
    name: Dispatch CI Investigation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Redact secrets from test output
        id: redact
        run: |
          # Redact common secret patterns from test output before sending to agent
          REDACTED_OUTPUT=$(echo '${{ inputs.test_output }}' | \
            sed -E 's/(ghp_|gho_|ghs_|github_pat_)[A-Za-z0-9_]{36,}/**REDACTED_TOKEN**/g' | \
            sed -E 's/(xoxb-|xoxp-|xoxs-)[A-Za-z0-9-]+/**REDACTED_SLACK_TOKEN**/g' | \
            sed -E 's/Bearer [A-Za-z0-9._-]+/Bearer **REDACTED**/g' | \
            sed -E 's/(sk-|pk_live_|pk_test_|sk_live_|sk_test_)[A-Za-z0-9]+/**REDACTED_KEY**/g' | \
            sed -E 's/[A-Za-z0-9+\/]{40,}=*/**POSSIBLE_SECRET_REDACTED**/g')

          # Write to file to avoid shell quoting issues
          echo "$REDACTED_OUTPUT" > /tmp/redacted_output.txt

          # Truncate if too large (max 50KB for agent context)
          if [ $(wc -c < /tmp/redacted_output.txt) -gt 51200 ]; then
            head -c 51200 /tmp/redacted_output.txt > /tmp/redacted_output_truncated.txt
            echo -e "\n\n--- OUTPUT TRUNCATED (exceeded 50KB limit) ---" >> /tmp/redacted_output_truncated.txt
            mv /tmp/redacted_output_truncated.txt /tmp/redacted_output.txt
          fi

      - name: Collect recent commits (post-merge)
        if: inputs.mode == 'post-merge'
        id: commits
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          fetch-depth: 20

      - name: Get commit log (post-merge)
        if: inputs.mode == 'post-merge'
        id: commit-log
        run: |
          # Get recent commits on main since this is a post-merge investigation
          COMMIT_LOG=$(git log --oneline --no-merges -20 2>/dev/null || echo "Unable to fetch commit log")
          echo "commit_log<<COMMIT_LOG_EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMIT_LOG" >> "$GITHUB_OUTPUT"
          echo "COMMIT_LOG_EOF" >> "$GITHUB_OUTPUT"

      - name: Dispatch CI investigator via orchestrator
        id: dispatch
        run: |
          # Build dispatch payload
          PAYLOAD=$(jq -n \
            --arg agent_id "teric-ci-investigator" \
            --arg mode "${{ inputs.mode }}" \
            --arg source "${{ inputs.source }}" \
            --arg repository "${{ inputs.repository }}" \
            --arg failed_tests '${{ inputs.failed_tests }}' \
            --arg run_id "${{ inputs.run_id }}" \
            --arg commit_sha "${{ inputs.commit_sha }}" \
            --argjson pr_number "${{ inputs.pr_number || 0 }}" \
            --arg commit_log "${{ steps.commit-log.outputs.commit_log || '' }}" \
            --rawfile test_output /tmp/redacted_output.txt \
            '{
              "agent_id": $agent_id,
              "inputs": {
                "mode": $mode,
                "source": $source,
                "repository": $repository,
                "failed_tests": $failed_tests,
                "test_output": $test_output,
                "run_id": $run_id,
                "commit_sha": $commit_sha,
                "pr_number": $pr_number,
                "recent_commits": $commit_log
              },
              "context": {
                "domain": "sdlc",
                "repository": $repository
              }
            }')

          # Call orchestrator dispatch endpoint
          DISPATCH_URL="${{ vars.ORCHESTRATOR_API_URL || 'https://api.teric.io/prod' }}/dispatch"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$DISPATCH_URL" \
            -H "Authorization: Bearer ${{ secrets.ORCHESTRATOR_DISPATCH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD") || {
            echo "::error::Failed to call orchestrator dispatch endpoint"
            exit 1
          }

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Dispatch failed with HTTP $HTTP_CODE: $BODY"
            exit 1
          fi

          EXECUTION_ID=$(echo "$BODY" | jq -r '.execution_id // .executionId // "unknown"')
          echo "execution_id=$EXECUTION_ID" >> "$GITHUB_OUTPUT"

          echo "### CI Investigation Dispatched" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Execution ID | \`$EXECUTION_ID\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Mode | ${{ inputs.mode }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Source | ${{ inputs.source }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Repository | ${{ inputs.repository }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Failed Tests | ${{ inputs.failed_tests }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Post investigation started (PR comment for pre-merge)
        if: inputs.mode == 'pre-merge' && inputs.pr_number > 0
        uses: actions/github-script@v7
        with:
          script: |
            const [owner, repo] = '${{ inputs.repository }}'.split('/');
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: ${{ inputs.pr_number }},
              body: `## CI Investigation Started\n\nA CI investigator agent has been dispatched to analyze the test failure.\n\n- **Execution ID**: \`${{ steps.dispatch.outputs.execution_id }}\`\n- **Mode**: ${{ inputs.mode }}\n- **Source**: ${{ inputs.source }}\n\nThe agent will post its findings as a follow-up comment.`
            });
