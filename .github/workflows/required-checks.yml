# PROC-007: Required Checks Wrapper Workflow
#
# This workflow is designed to be configured as an org-wide required workflow.
# It wraps the contract validation workflow and ensures all repositories
# comply with contract validation requirements.
#
# Configuration:
#   GitHub Org Settings > Actions > Workflows > Required workflows
#   Add this workflow and apply to all or selected repositories.
#
# Reference: teric-planning/PROC-007-early-integration-bug-detection.md

name: Required Checks

# Required workflow - triggers on PRs in all configured repos
# This is designed to be set as an org-wide required workflow
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # Check for bypass label
  check-bypass:
    name: Check Bypass
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Check for bypass conditions
        id: check
        run: |
          # Check for emergency bypass label
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          if echo "$LABELS" | grep -q "contract-bypass"; then
            echo "::warning::Contract validation bypassed via contract-bypass label"
            echo "skip=true" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "contract-advisory"; then
            echo "::notice::Running in advisory mode via contract-advisory label"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "advisory=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "advisory=false" >> $GITHUB_OUTPUT
          fi

  # Run contract validation
  contract-validation:
    name: Contract Validation
    needs: check-bypass
    if: needs.check-bypass.outputs.should_skip != 'true'
    uses: teric-io/.github/.github/workflows/contract-validation.yml@main
    with:
      # Use advisory mode if:
      # 1. The contract-advisory label is present
      # 2. The repository has a .github/contract-config.yml with advisory: true
      advisory_only: ${{ contains(github.event.pull_request.labels.*.name, 'contract-advisory') }}
    secrets: inherit

  # Run integration checker for cross-repo validation
  integration-check:
    name: Integration Check
    needs: check-bypass
    if: needs.check-bypass.outputs.should_skip != 'true'
    uses: teric-io/.github/.github/workflows/integration-checker.yml@main
    with:
      check_dependents: false
    secrets: inherit

  # Summary job that aggregates results
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [check-bypass, contract-validation, integration-check]
    if: always()
    steps:
      - name: Check validation results
        run: |
          # Check if validation was bypassed
          if [[ "${{ needs.check-bypass.outputs.should_skip }}" == "true" ]]; then
            echo "::warning::Validation was bypassed - please ensure this is intentional"
            exit 0
          fi

          # Check contract validation result
          CONTRACT_RESULT="${{ needs.contract-validation.result }}"
          INTEGRATION_RESULT="${{ needs.integration-check.result }}"

          echo "Contract Validation: $CONTRACT_RESULT"
          echo "Integration Check: $INTEGRATION_RESULT"

          if [[ "$CONTRACT_RESULT" == "failure" ]]; then
            echo "::error::Contract validation failed - please fix violations before merging"
            exit 1
          fi

          if [[ "$INTEGRATION_RESULT" == "failure" ]]; then
            echo "::error::Integration check failed - please verify compatibility"
            exit 1
          fi

          echo "::notice::All required checks passed"
