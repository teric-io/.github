# FEAT-038: PR CI Failure Handler
#
# Detects CI failures on pull requests and triggers CI investigation.
# This workflow monitors CI workflow completions and dispatches a
# CI investigator agent to diagnose failures and post analysis on the PR.
#
# Trigger: workflow_run completion of CI workflows on PRs.
# Action: Calls ci-investigation-dispatch.yml reusable workflow.
#
# Related:
# - teric-planning/FEAT-038-automated-ci-failure-investigation.md (Phase 4)
# - ci-investigation-dispatch.yml (reusable dispatch workflow)

name: PR CI Failure Handler

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  check-failure:
    name: Check for CI Failure
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    outputs:
      should_investigate: ${{ steps.check.outputs.should_investigate }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      failed_tests: ${{ steps.extract.outputs.failed_tests }}
      test_output: ${{ steps.extract.outputs.test_output }}
    steps:
      - name: Check if investigation is warranted
        id: check
        run: |
          # Extract PR number from the workflow run (handle empty array and null)
          PR_COUNT=$(echo '${{ toJSON(github.event.workflow_run.pull_requests) }}' | jq 'length')

          if [ "$PR_COUNT" -eq 0 ]; then
            echo "No PR associated with this workflow run, skipping"
            echo "should_investigate=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER=$(echo '${{ toJSON(github.event.workflow_run.pull_requests) }}' | jq -r '.[0].number')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "PR number could not be extracted, skipping"
            echo "should_investigate=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "CI workflow failed on PR #$PR_NUMBER"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "should_investigate=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Download test artifacts
        if: steps.check.outputs.should_investigate == 'true'
        id: download
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: /tmp/test-artifacts
        continue-on-error: true

      - name: Extract failure details
        if: steps.check.outputs.should_investigate == 'true'
        id: extract
        run: |
          if [ -d "/tmp/test-artifacts" ]; then
            FOUND_FILES=$(find /tmp/test-artifacts -type f | wc -l)
            echo "::notice::Found $FOUND_FILES artifact files"

            # Look for common test output files across frameworks
            TEST_OUTPUT=$(find /tmp/test-artifacts \
              \( -name "*.log" -o -name "*.txt" -o -name "test-results*" -o -name "junit*.xml" -o -name "*.tap" \) \
              -type f -exec cat {} \; 2>/dev/null | head -500 || echo "No test output artifacts found")
            FAILED_TESTS=$(find /tmp/test-artifacts -name "failed-tests*" -type f | \
              head -1 | xargs cat 2>/dev/null || echo '["unknown"]')
          else
            TEST_OUTPUT="Test artifacts not available. Check workflow run ${{ github.event.workflow_run.id }} for details."
            FAILED_TESTS='["unknown"]'
          fi

          echo "test_output<<TEST_OUTPUT_EOF" >> "$GITHUB_OUTPUT"
          echo "$TEST_OUTPUT" >> "$GITHUB_OUTPUT"
          echo "TEST_OUTPUT_EOF" >> "$GITHUB_OUTPUT"

          echo "failed_tests=$FAILED_TESTS" >> "$GITHUB_OUTPUT"

  dispatch:
    name: Dispatch Investigation
    needs: check-failure
    if: needs.check-failure.outputs.should_investigate == 'true'
    # Pin to current commit SHA to avoid race conditions with workflow updates
    uses: teric-io/.github/.github/workflows/ci-investigation-dispatch.yml@${{ github.sha }}
    with:
      source: ci-failure
      mode: pre-merge
      repository: ${{ github.repository }}
      failed_tests: ${{ needs.check-failure.outputs.failed_tests || '["unknown"]' }}
      test_output: ${{ needs.check-failure.outputs.test_output || 'No test output available' }}
      run_id: ${{ github.event.workflow_run.id }}
      commit_sha: ${{ github.event.workflow_run.head_sha }}
      pr_number: ${{ needs.check-failure.outputs.pr_number }}
    secrets:
      ORCHESTRATOR_DISPATCH_TOKEN: ${{ secrets.ORCHESTRATOR_DISPATCH_TOKEN }}
